
<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>

    <title>Conquering Corsairs! A Piratical Deck-building Game</title>
    <link rel="icon" type="image/png" href="/favicon.png" />
    <link rel="stylesheet" type="text/css" href="/css/site.css"></link>

    <!-- JQuery in top level js and css -->
    <link rel="stylesheet" href="/css/ui-lightness/jquery-ui-1.8.18.custom.css" type="text/css" />
    <script src="/js/jquery-1.7.2.min.js"></script>
    <script src="/js/jquery-ui-1.8.18.custom.min.js"></script>
    <script src="/js/jquery.ui.touch-punch.js"></script>

    <script src="/js/site.js"></script>
    <meta property="fb:admins" content="577727081" />

</head>
<body>
    <div id="fb-root"></div>

    <script>
(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=29741103201";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

    <script type="text/javascript">
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
    </script>

    <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-38007974-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

    </script>

    <script type="text/javascript" src="http://assets.pinterest.com/js/pinit.js"></script>

    <div id="bgcol">
        <div id="header" width="100%">
            <center>
                <a href="http://www.conqueringcorsairs.com/" border="0"><img alt="Conquering Corsairs" src="/images/text/conquering-corsairs.png"></a>
            </center>


            <div id="menu" width="100%" height="20">
                <span style="width:3px;">&nbsp;</span>
                <button class="menu_head" id="btn_about">About &#187;</button>
                <button class="menu_head" id="btn_rules">Rules &#187;</button>
                <button class="menu_head" id="btn_cards">Cards &#187;</button>
                <button class="menu_head" id="btn_factions">World &#187;</button>
                <button class="menu_head_grey" id="btn_play">Play!</button>
                &nbsp;
                <button class="menu_head" id="btn_shop" onclick="location.href='/shop/index.html';"><a href="/shop/index.html">Shop &#187;</a></button>
                &nbsp;

                <span style="float:right;">
                    <button class="menu_head" id="btn_discuss">Discuss &#187;</button>
                    <button class="menu_head" id="btn_social">Social &#187;</button>
                    <span style="width:3px;">&nbsp;</span>
                </span>
            </div>
        </div>
    </div>
    <ul class="menu_body" id="btn_about_body">
        <li>&#187; <a href="/">Home</a></li>
        <li>&#187; <a href="/about/deckBuilding.html">Deck-building?</a></li>
        <li>&#187; <a href="/about/whyBuy.html">Why Buy it?</a></li>
        <li>&#187; <a href="/about/who.html">Who We Are?</a></li>
        <li>&#187; <a href="/about/whyMade.html">Why We Made It?</a></li>
        <li>&#187; <a href="/about/thanks.html">Thanks!</a></li>
    </ul>

    <ul class="menu_body" id="btn_rules_body">
        <li>&#187; <a href="/rules/learnToPlay.html">Learn to Play</a></li>
        <li>&#187; <a href="/rules/FAQ.html">FAQ</a></li>
        <li>&#187; <a href="/rules/tipsAndTricks.html">Tips and Tricks</a></li>

        <li>&#187; <a href="/rules/technical.html">Technical Rules</a></li>
    </ul>
    <ul class="menu_body" id="btn_cards_body">
        <li>&#187; <a href="/cards/pirates.html">Pirates</a></li>
        <li>&#187; <a href="/cards/actions.html">Actions</a></li>
        <li>&#187; <a href="/cards/ships.html">Ships</a></li>
        <li>&#187; <a href="/cards/locations.html">Locations</a></li>
        <li>&#187; <a href="/cards/cards-full-final.pdf">All</a> (50Mb pdf)</li>
    </ul>
    <ul class="menu_body" id="btn_factions_body" style="width: 180px">
        <li style="height: 24px">&#187; <a href="/world/index.html">The Silver Seas</a></li>
        <li style="height: 24px">&#187; <a href="/world/spiral.html">Etterian&nbsp;Spiral</a> <span style="float:right"><img src="/images/icons/leaf.png" height="22px"></span></li>
        <li style="height: 24px">&#187; <a href="/world/taghmart.html">Taghmart&nbsp;Armada</a>  <span style="float:right"><img src="/images/icons/mask.png" height="18px"></span>  </li>
        <li style="height: 24px">&#187; <a href="/world/undead.html">Greedy&nbsp;Dead</a> <span style="float:right"><img src="/images/icons/skull.png" height="22px"></span> </li>
        <li style="height: 24px">&#187; <a href="/world/crows.html">Crows&nbsp;of&nbsp;Ruin</a> <span style="float:right"><img src="/images/icons/crow.png" height="22px"></span> </li>
    </ul>

    <ul class="menu_body" id="btn_discuss_body" style="width: 200px;">
        <li>&#187; <a href="https://groups.google.com/forum/#!forum/conqueringcorsairs">Rules and Game Play</a>
        <li>&#187; <a href="https://groups.google.com/forum/#!forum/silver-seas-design">The World</a>
        <li>&#187; <a href="http://boardgamegeek.com/boardgame/136847/conquering-corsairs">Board Game Geek</a>
    </ul>

    <ul class="menu_body" id="btn_social_body" style="width: 200px;">
        <li><div class="fb-like" data-send="true" data-layout="button_count" data-width="450" data-show-faces="true">Facebook</div> </li>

        <li><a href="https://twitter.com/share" data-url="http://www.conqueringcorsairs.com/" data-related="ConqCorsairs:Conquering Corsairs Twitter account" class="twitter-share-button" data-lang="en" data-text="Check out Conquering Corsairs: a Pirate Deckbuilding game!">Tweet This</a>


        <li><g:plusone annotation="inline" width="300" href="http://www.conqueringcorsairs.com/"></g:plusone></li>

        <li>
            <a href="http://pinterest.com/pin/create/button/?url=http%3A%2F%2Fwww.conqueringcorsairs.com%2F&media=http%3A%2F%2Fwww.conqueringcorsairs.com%2Fimages%2Fsailor.jpg&description=Conquering%20Corsairs%20is%20a%20card%20game%20in%20which%20you%20take%20the%20role%20of%20pirates%2C%20trying%20to%20gain%20gold%20and%20reputation%20to%20become%20the%20most%20feared%20and%20famous%20ship%20to%20sail%20the%20Silver%20Seas.%20You%20will%20take%20your%20ship%20to%20strange%20and%20dangerous%20locations%2C%20recruit%20new%20crew%20members%20to%20your%20cause%2C%20do%20battle%20with%20other%20pirates%2C%20and%20put%20plunder%20in%20your%20treasure%20chest!%20" class="pin-it-button" count-layout="horizontal">
                <img border="0" src="//assets.pinterest.com/images/PinExt.png" title="Pin It" />
            </a>
        </li>
        <li>&#187; <a href="https://twitter.com/#!/ConqCorsairs">@ConqCorsairs</a>
        <li>&#187; <a href="mailto:crew@conqueringcorsairs.com">crew@ conqueringcorsairs.com</a></li>
    </ul>

    <br />

    <div id="content">

        <script src="openseadragon/openseadragon.min.js"></script>
        <script src="jquery-1.11.1.min.js"></script>

        <h2>IIIF Open SeaDragon Authentication Test</h2>

        <table width="100%">
            <tr width="100%">
                <td valign="top">
                    <div id="containerleft" width="400" height="400">&nbsp;</div>
                    <div>
                        <div id="authboxleft" style="margin-top: 10px; border: 2px solid green;"></div>
                        <div id="logleft" style="margin-top: 10px; border: 2px solid black;"></div>
                    </div>
                </td>
                <td valign="top">
                    <div id="containerright" width="400" height="400">&nbsp;</div>
                    <div>
                        <div id="authboxright" style="margin-top: 10px; border: 2px solid green;"></div>
                        <div id="logright" style="margin-top: 10px; border: 2px solid black"></div>
                    </div>
                </td>
            </tr>
        </table>

        <script type="text/javascript">

var lineleft = 0;
var lineright = 0;

function log(text, lr) {

    if (lr == "left") {
        lineleft += 1;
        l = lineleft;
    } else {
        lineright += 1;
        l = lineright;
    }
    $('#log'+lr).prepend("[" + l + "] " + text + "<br>");
}

// check for an auth service ... once tileSource has loaded
function on_authed(lr) {
    // first try to get an authorization token from the token service ...
    // via JSONP :(
    // XXX TODO: get the URL from the info.json
    log("Fetching Token", lr);
    var base = get_url(lr)
    if (lr == "left") {
        $.getJSON(base+"token?callback=?", on_tokened_left);
    } else {
        $.getJSON(base+"token?callback=?", on_tokened_right);
    }
}

function on_tokened_left(data) {
    on_tokened(data, 'left')
}
function on_tokened_right(data) {
    on_tokened(data, 'right')
}

function on_tokened(data, lr) {

    var token, error;
    if (data.hasOwnProperty('access_token')) {
        token = data.access_token;
        error = false;
        log("Got token: " + token, lr);
    } else {
        // error condition
        token = '';
        error = true;
        log("Got error: " + data.error, lr)
    }

    if (error) {
        // Error make unauthed viewer
        make_viewer(lr);
    } else {
        // Okay, make authed viewer
        var base = get_url(lr);
        $('#openseadragon'+lr).remove();
        $('#authbox'+lr).empty();
        $('#container'+lr).append('<div id="openseadragon'+lr+'" style="width: 350px; height: 400px; border: 2px solid purple" ></div>');
        if (lr == 'left') {
            $.ajax({ url:base+"f1rc/info.json", headers: {"Authorization":token}, cache: false, success: on_got_info_left });
        } else {
            $.ajax({ url:base+"f1rc/info.json", headers: {"Authorization":token}, cache: false, success: on_got_info_right });
        }
    }
}

function on_got_info_left(data) {
    on_got_info(data, 'left');
}
function on_got_info_right(data) {
    on_got_info(data, 'right');
}

function on_got_info(data, lr) {

    log("Got full info.json", lr)

    process_auth_services(data, 'logout', lr);

    var viewer = OpenSeadragon({
        id: "openseadragon" + lr,
        tileSources: data,
        showNavigator: true,
        prefixUrl: "/auth/openseadragon/images/"
    });
}

function do_auth_left(evt) {
    var login = $(this).attr('data-login')
    do_auth(login, 'left');
}
function do_auth_right(evt) {
    var login = $(this).attr('data-login')
    do_auth(login, 'right');
}

function do_auth(login, lr) {

    // The redirected to window will self-close
    // open/closed state is the only thing we can see across domains :(
    log("Opening Auth service", lr);
    var win = window.open(login, 'loginwindow'+lr);
    var pollTimer   =   window.setInterval(function() {
        if (win.closed) {
            window.clearInterval(pollTimer);
            on_authed(lr);
        }
    }, 500);
}

function process_auth_services(info, which, lr) {

    log("Looking for auth services", lr)
    if (info.hasOwnProperty('service')) {
        if (info.service.hasOwnProperty('@context')) {
            services = [info.service]
        } else {
            // array of service
            services = info.service
        }
        for (var service,i=0;service=services[i];i++) {
            if (service['profile'] == 'http://iiif.io/api/image/2/auth/' + which) {
                var login = service['@id'];
                log("Found "+which+" auth service: " + login, lr);
                $('#authbox'+lr).append("<button id='authbutton"+lr+"' data-login='"+login+"'>"+service.label+"</button>");
                if (lr == "left") {
                    $('#authbutton'+lr).bind('click', do_auth_left);
                } else {
                    $('#authbutton'+lr).bind('click', do_auth_right);
                }
            } else if (which == 'login' && service['profile'] == 'http://iiif.io/api/image/2/auth/token') {
                // save token service here...
            }
        }
    }
}


function handle_open_left(event) {
    handle_open(event, "left");
    // make_viewer("right");
}
function handle_open_right(event) {
    handle_open(event, "right");
}

function handle_open(event, lr) {
    var info = event.eventSource.source;
    // This only gets called when we're NOT authed, so no need to put in logout
    process_auth_services(info, 'login', lr);
}

function make_viewer(lr) {

    log("Making unauthed viewer", lr);

    $('#openseadragon'+lr).remove();
    $('#authbox'+lr).empty();
    $('#container'+lr).append('<div id="openseadragon'+lr+'" style="width: 350px; height: 400px; border: 2px solid purple" >&nbsp;</div>');
    var where = $("#openseadragon"+lr);

    var base = get_url(lr);
    var viewer = OpenSeadragon({
        id: "openseadragon"+lr,
        tileSources: base+"f1rc/info.json?t=" + new Date().getTime(),
        showNavigator: true,
        prefixUrl: "/auth/openseadragon/images/"
    });
    if (lr == "left") {
        viewer.addHandler('open', handle_open_left)
        viewer.addHandler('failed-open', handle_open_left)
    } else {
        viewer.addHandler('open', handle_open_right)
        viewer.addHandler('failed-open', handle_open_right)
    }
}

function get_url(lr) {
    if (lr == "left") {
        return "http://dlss-dev-azaroth.stanford.edu/services/iiif/"
    } else {
        return "http://dlss-dev-azaroth.stanford.edu/services/iiif_basic/"
    }

}

make_viewer("left");
make_viewer("right");
        </script>


</body>
</html>

    	</div>
	</body>
</html>
